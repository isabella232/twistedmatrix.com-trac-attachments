<html>
<!--XSLT stylesheet used to transform this file:  dw-document-html-2.1.xsl-->
<head>
<title>Network programming with the Twisted framework, Part 1</title>
</head>
<body bgcolor="#ffffff" marginheight="2" marginwidth="2" topmargin="2" leftmargin="2">
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr>
<td width="160" class="tbgc"><a href="http://www-106.ibm.com/developerworks/cgi-bin/click.cgi?url=http://www.ibm.com/&origin=dwheader"><img 
src="http://www-106.ibm.com/developerworks/i/ibm-logo.gif" border="0" alt="IBM" 
width="160" height="47"/></a></td>
<td width="90" class="tbgdw"><a 
href="#main"><img src="http://www-106.ibm.com/developerworks/i/c.gif" border="0" width="70" 
height="1" alt="Skip to main content"/></a></td>

<td width="100%" class="tbgc" 
align="right" valign="top">
<table border="0" cellpadding="0" cellspacing="0"> 
<form method="get" action="http://www-106.ibm.com/search/searchResults.jsp" id="form1" name="form1"><input type="hidden" name="searchType" value="1">
<input type="hidden" name="searchSite" value="dW">
 
<tr><td colspan="7"><img src="http://www-106.ibm.com/developerworks/i/c.gif" 
border="0" width="390" height="4" alt="" /></td></tr>

<tr valign="middle" nowrap>
<td class="dwsearch24"><b>Search for:</b>&nbsp;</td>
<td><input type=text class="dwsearch" name="query" height=15 size=18 maxlength=100/></font></td>
<td class="dwsearch24">&nbsp;<b>within</b>&nbsp;</td>
<td class="dwsearch"><select name="searchScope" class="dwsearch"> 
<option value="dW">All of dW</option>
<option value="gridZ">&nbsp;Grid computing</option>
<option value="javaZ">&nbsp;Java technology</option> 
<option value="linuxZ">&nbsp;Linux</option> 
<option value="opensrcZ">&nbsp;Open source</option>
<option value="securityZ">&nbsp;Security</option>
<option value="webarchZ">&nbsp;Web arch.</option>  
<option value="webservZ">&nbsp;Web services</option> 
<option value="wirelessZ">&nbsp;Wireless</option> 
<option value="xmlZ">&nbsp;XML</option>
<option value="dW">.................</option>
<option value="forum">&nbsp;dW forums</option>  
<option value="dW">.................</option>
<option value="dW">Product domains:</option>
<option value="ibmofferZ">&nbsp;IBM developer</option> 
<option value="ibmofferZ">&nbsp;&nbsp;&nbsp;solutions</option>
<option value="db2">&nbsp;DB2</option>
<option value="WSDD">&nbsp;WebSphere</option>
<option value="WSDD">&nbsp;&nbsp;&nbsp;(WSDD)</option> 
<option value="dW">.................</option> 
<option value="aW">alphaWorks</option>
<option value="dW">.................</option> 
<option value="all">All of IBM</option> 
</select></td>

<td><img src="http://www-106.ibm.com/developerworks/i/c.gif" border="0" width="5" height="1" alt="" /></td>
<td><input type="image" src="http://www.ibm.com/i/v11/m/en/search.gif" width="64" height="23" border="0" value="Search" name="Search" alt="Search button"/></td>
<td valign="top"><img src="http://www-106.ibm.com/developerworks/i/c.gif" border="0" width="10" height="1" alt="" /></td></tr>

<tr valign="top">
<td>&nbsp;</td>
<td class="dwsmallwh">Use + - (&nbsp;) "&nbsp;"<img src="http://www-106.ibm.com/developerworks/i/c.gif" border="0" width="1" height="1" alt="" /></td>
<td>&nbsp;</td><td class="dwsmall"><a href="http://www-106.ibm.com/developerworks/search/help-dw.html" style="color: #ffffff;" target="_blank">Search help</a><img src="http://www-106.ibm.com/developerworks/i/c.gif" border="0" width="1" height="1" alt="" /></td>
<td colspan="4">&nbsp;</td>
</tr>

<tr><td colspan="8"><img src="http://www-106.ibm.com/developerworks/i/c.gif" 
border="0" width="390" height="4" alt="" /></td></tr>
</table>

</td></tr></form>

<tr><td width="160" height="21" class="hbg">&nbsp;</td><td colspan="2" height="21" valign="top" class="bbg">&nbsp;&nbsp;&nbsp;<a class="mainlink" 
href="http://www-106.ibm.com/developerworks/cgi-bin/click.cgi?url=http://www.ibm.com/&origin=dwheader">IBM home</a><span class="divider">&nbsp;&nbsp;|&nbsp;&nbsp;</span><a class="mainlink" href="http://www-106.ibm.com/developerworks/cgi-bin/click.cgi?url=http://www.ibm.com/products/&origin=dwheader">Products &amp; services</a><span 
class="divider">&nbsp;&nbsp;|&nbsp;&nbsp;</span><a class="mainlink" 
href="http://www-106.ibm.com/developerworks/cgi-bin/click.cgi?url=http://www.ibm.com/support/">Support &amp; downloads</a> <span 
class="divider">&nbsp;&nbsp;|&nbsp;&nbsp;</span><a class="mainlink" 
href="http://www-106.ibm.com/developerworks/cgi-bin/click.cgi?url=http://www.ibm.com/account/&origin=dwheader">My account</a></td></tr></table><table width="100%" cellspacing="0" cellpadding="0" border="0"><tr class="hil"><td width="100%" height="1"><img src="/developerworks/i/c.gif" width="600" height="1" alt=""></td></tr><tr class="dwr1"><td width="100%" height="2"><img src="/developerworks/i/c.gif" width="600" height="2" alt=""></td></tr><tr class="dwg3"><td width="100%" height="1"><img src="/developerworks/i/c.gif" width="600" height="1" alt=""></td></tr><tr class="bbg"><td width="100%" height="1"><img src="/developerworks/i/c.gif" width="600" height="1" alt=""></td></tr><tr class="hil"><td width="100%" height="1"><img src="/developerworks/i/c.gif" width="600" height="1" alt=""></td></tr></table><table width="100%" cellspacing="0" cellpadding="0" border="0"><tr valign="top"><td width="5"><img src="/developerworks/i/c.gif" width="5" height="1" border="0" alt=""></td><td width="100%"><table width="100%" cellspacing="0" cellpadding="0" border="0"><tr valign="top"><td width="100%"><img src="/developerworks/i/c.gif" width="2" height="4" border="0" alt=""><br><a class="dwbctl" href="http://www-106.ibm.com/developerworks/">IBM developerWorks</a>  &gt;  
        <a class="dwbctl" href="http://www-106.ibm.com/developerworks/linux/">Linux</a></td><td width="136" align="right"><a href="http://www-106.ibm.com/developerworks/"><img src="/developerworks/i/dwlogo-small.gif" width="136" height="24" border="0" alt="developerWorks"></a></td><td width="5"><img src="/developerworks/i/c.gif" width="5" height="1" border="0" alt=""></td></tr></table></td></tr></table><a name="main"></a><table width="100%" cellspacing="0" cellpadding="0" border="0"><tr valign="top"><td colspan="5"><img src="/developerworks/i/c.gif" width="5" height="15" border="0" alt=""></td></tr><tr valign="top"><td width="2"><img src="/developerworks/i/c.gif" width="2" height="1" border="0" alt=""></td><td><span class="atitle">Network programming with the Twisted framework, Part 1</span></td><td width="8"><img src="/developerworks/i/c.gif" width="8" height="1" border="0" alt=""></td><td width="180" align="right"><img src="/developerworks/i/c.gif" width="180" height="1" border="0" alt=""><br><nobr><a href="javascript:void newWindow()"><img src="/developerworks/i/icon-email.gif" width="46" height="26" border="0" alt="e-mail it!"></a></nobr></td><td width="6"><img src="/developerworks/i/c.gif" width="6" height="1" border="0" alt=""></td></tr><tr valign="top"><td colspan="5" bgcolor="#000000"><img src="/developerworks/i/c.gif" width="100" height="1" border="0" alt=""></td></tr><tr valign="top"><td colspan="5" bgcolor="#FFFFFF"><img src="/developerworks/i/c.gif" width="100" height="8" border="0" alt=""></td></tr></table><table width="100%" border="0" cellspacing="0" cellpadding="0"><tr valign="top"><td width="5"><img src="/developerworks/i/c.gif" width="5" height="1" border="0" alt=""></td><td width="100%"><table width="168" align="right" border="0" cellspacing="0" cellpadding="0"><tr><td width="8"><img src="/developerworks/i/c.gif" width="5" height="21" alt=""></td><td width="160"><table width="160" border="0" cellspacing="0" cellpadding="0"><tr><td bgcolor="#000000" height="1" width="160"><img src="/developerworks/i/c.gif" width="160" height="1" alt=""></td></tr><tr><td height="5" background="/developerworks/i/bg-gold.gif" align="center"><b>Contents:</b></td></tr><tr><td bgcolor="#666666" height="1" width="160"><img src="/developerworks/i/c.gif" width="160" height="1" alt=""></td></tr><tr><td><table width="160" border="0" cellspacing="0" cellpadding="0"><tr><td><a href="#IDABCMVB">A first server</a></td></tr><tr><td height="1"><img src="/developerworks/i/c.gif" width="160" height="5" alt=""></td></tr><tr><td><a href="#IDAEEMVB">The parts of a Twisted server</a></td></tr><tr><td height="1"><img src="/developerworks/i/c.gif" width="160" height="5" alt=""></td></tr><tr><td><a href="#IDAMGMVB">An enhanced server</a></td></tr><tr><td height="1"><img src="/developerworks/i/c.gif" width="160" height="5" alt=""></td></tr><tr><td><a href="#IDAIYMVB">Persistence and scheduling</a></td></tr><tr><td height="1"><img src="/developerworks/i/c.gif" width="160" height="5" alt=""></td></tr><tr><td><a href="#IDAM1MVB">What next?</a></td></tr><tr><td height="1"><img src="/developerworks/i/c.gif" width="160" height="5" alt=""></td></tr><!--Standard links for every dw-article--><tr><td><a href="#resources">Resources</a></td></tr><tr><td height="1"><img src="/developerworks/i/c.gif" width="160" height="5" alt=""></td></tr><tr><td><a href="#author1">About the author</a></td></tr><tr><td height="1"><img src="/developerworks/i/c.gif" width="160" height="5" alt=""></td></tr><tr><td><a href="#rating">Rate this article</a></td></tr><tr><td><img src="/developerworks/i/c.gif" width="160" height="10" alt=""></td></tr></table></td></tr></table><table width="160" border="0" cellspacing="0" cellpadding="0"><tr><td bgcolor="#000000" height="1" width="160"><img src="/developerworks/i/c.gif" width="160" height="1" alt=""></td></tr><tr><td height="5" background="/developerworks/i/bg-gold.gif" align="center"><b>Related content:</b></td></tr><tr><td bgcolor="#666666" height="1" width="160"><img src="/developerworks/i/c.gif" width="160" height="1" alt=""></td></tr><tr><td><table width="160" border="0" cellspacing="0" cellpadding="0"><tr><td><a href="http://www-106.ibm.com/developerworks/xml/library/x-tipasysax.html" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">Asynchronous SAX</a></td></tr><tr><td height="1"><img src="/developerworks/i/c.gif" width="160" height="5" alt=""></td></tr><tr><td><a href="http://www-106.ibm.com/developerworks/webservices/library/ws-asynch1.html" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">Asynchronous operations and Web services, Part 1: A primer on asynchronous transactions</a></td></tr><tr><td height="1"><img src="/developerworks/i/c.gif" width="160" height="5" alt=""></td></tr><tr><td><a href="http://www-106.ibm.com/developerworks/cgi-bin/click.cgi?url=www-106.ibm.com/developerworks/newsletter/&amp;origin=dw-article">Subscribe to the developerWorks newsletter</a></td></tr><tr><td height="1"><img src="/developerworks/i/c.gif" width="160" height="5" alt=""></td></tr><tr><td><a href="http://www-106.ibm.com/developerworks/toolbox/">developerWorks Toolbox subscription</a></td></tr><tr><td height="1"><img src="/developerworks/i/c.gif" width="160" height="5" alt=""></td></tr></table></td><td><!--Related Zone content--><tr><td height="1"><img src="/developerworks/i/c.gif" width="160" height="5" alt=""></td></tr><!--Related Zone Navigation content--><tr><td><table width="160" border="0" cellspacing="0" cellpadding="0"><tr><td bgcolor="#000000" height="1" width="160"><img src="/developerworks/i/c.gif" width="160" height="1" alt=""></td></tr><tr><td height="5" background="/developerworks/i/bg-gold.gif" align="center"><a class="nav" href="http://www-106.ibm.com/developerworks/linux/"><b>Also in the Linux zone:</b></a></td></tr><tr><td bgcolor="#666666" height="1" width="160"><img src="/developerworks/i/c.gif" width="160" height="1" alt=""></td></tr><tr><td><table width="160" border="0" cellspacing="0" cellpadding="0"><tr><td><a href="http://www-106.ibm.com/developerworks/views/linux/tutorials.jsp">Tutorials</a></td></tr><tr><td height="1"><img src="/developerworks/i/c.gif" width="160" height="5" alt=""></td></tr><tr><td><a href="http://www-106.ibm.com/developerworks/views/linux/tools.jsp">Tools and products</a></td></tr><tr><td height="1"><img src="/developerworks/i/c.gif" width="160" height="5" alt=""></td></tr><tr><td><a href="http://www-106.ibm.com/developerworks/views/linux/code.jsp">Code and components</a></td></tr><tr><td height="1"><img src="/developerworks/i/c.gif" width="160" height="5" alt=""></td></tr><tr><td><a href="http://www-106.ibm.com/developerworks/views/linux/articles.jsp">Articles</a></td></tr><tr><td height="1"><img src="/developerworks/i/c.gif" width="160" height="5" alt=""></td></tr></table></td></tr></table></td></tr><tr><td height="1"><img src="/developerworks/i/c.gif" width="160" height="5" alt=""></td></tr></td></tr></table><table width="160" border="0" cellspacing="0" cellpadding="0"><tr><td colspan="2" bgcolor="#000000" height="2" width="150"><img src="/developerworks/i/c.gif" width="160" height="2" alt=""></td></tr><tr><td colspan="2" bgcolor="#FFFFFF" height="2" width="150"><img src="/developerworks/i/c.gif" width="160" height="2" alt=""></td></tr></table></td></tr></table><span class="atitle2">Understanding asynchronous networking</span><br><table cellpadding="0" cellspacing="0" border="0"><tr align="left" valign="top"><td><p>Level: Intermediate</p></td></tr></table><p><a href="#author1">David Mertz, Ph.D.</a> (<a href="mailto:mertz@gnosis.cx">mertz@gnosis.cx</a>)<br>Programmer, Gnosis Software, Inc.<br>June 25,  2003</p><blockquote>Twisted is an increasingly popular pure-Python framework for programming network services and applications. While there are a large number of loosely coupled modular components within Twisted, a central concept to the framework is the idea of non-blocking asynchronous servers. In this article, David introduces you to this style of programming -- a novel one for developers accustomed to threading or forking servers, but one capable of great efficiency under heavy loads.</blockquote><p>
  Sorting through the Twisted framework is reminiscent of the old story
  about blind men and elephants. Twisted has many
  capabilities, and it takes a bit of a paradigm switch
  to get a good sense of why they are all there. In fact, as I write this first installment, 
  I am probably only halfway toward
  getting my mind fully around Twisted. We can
  work through it together.
</p><p>
  One of the strengths of recent versions of Python is that they
  come with "batteries included" -- that is, the standard
  distribution includes modules to do just about everything you
  want to accomplish in most programming tasks. For the most part,
  when you want a third-party Python module or package, it is to
  accomplish some specialized and unusual task. Twisted is
  one of few exceptions to the pattern described; developed by
  Twisted Matrix Laboratories, it is a
  well-designed and general-purpose collection of modules for
  performing all manner of network programming tasks, in ways not
  easily facilitated by Python's standard library.
</p><p>
  It is not quite true that Python's standard library lacks
  support for asynchronous, non-blocking network applications.
  The module <code>asyncore</code> provides basic
support for switching
  among I/O channels within a single thread. But Twisted
  takes the style to a higher level and provides a huge
  collection of pre-built and reusable protocols, interfaces, and
  components.
</p><p><a name="IDABCMVB"><span class="atitle2">A first server</span></a><br>
  The documentation that accompanies Twisted is quite
  extensive, but hard to get a handle on. Let's start with a
  simple server, and build on that. In a recent
  <i xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">developerWorks</i> tip (see <a href="#resources" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">Resources</a> for a link), 
  I demonstrated an XML-based "Weblog server"
  that presents to a client a stream of records about the latest
  hits to a Web server. The XML aspect is not important here,
   but the use of <code>SocketServer</code> and its
<code>ThreadingTCPServer</code> class
  is useful as a baseline. This pre-Twisted server consists of:
</p><a name="IDAXCMVB"><b>Listing 1. SocketServer-weblog.py</b></a><br><table border="1" cellspacing="0" cellpadding="5" width="100%" bgcolor="#CCCCCC"><tr><td><pre><code>
from SocketServer import BaseRequestHandler, ThreadingTCPServer
from time import sleep
import sys, socket
from webloglib import log_fields, hit_tag

class WebLogHandler(BaseRequestHandler):
    def handle(self):
        print "Connected from", self.client_address
        self.request.sendall('&lt;hits&gt;')
        try:
            while True:
                for hit in LOG.readlines():
                    self.request.sendall(hit_tag % log_fields(hit))
                sleep(5)
        except socket.error:
            self.request.close()
        print "Disconnected from", self.client_address

if __name__=='__main__':
    global LOG
    LOG = open('access-log')
    LOG.seek(0, 2)     # Start at end of current access log
    srv = ThreadingTCPServer(('',8888), WebLogHandler)
    srv.serve_forever()
</code></pre></td></tr></table><p>
  Other than that overhead of its per-client thread creation, a
   notable feature of the <code>SocketServer</code>-based server is its use of
   a blocking call to <code>time.sleep()</code> within its
handler. For Twisted's non-blocking <code>select()</code> loop,
such a block is not permissible.
</p><p>
  A first non-blocking approach pushes any artificial delays onto
  the client, and lets the client specifically request each new
  batch of Weblog records (and also sends a message to indicate
  their absence, rather than send nothing). This Twisted server
  looks like:
</p><a name="IDAPDMVB"><b>Listing 2. twisted-weblog-1.py</b></a><br><table border="1" cellspacing="0" cellpadding="5" width="100%" bgcolor="#CCCCCC"><tr><td><pre><code>
from twisted.internet import reactor
from twisted.internet.protocol import Protocol, Factory
from webloglib import hit_tag, log_fields

class WebLog(Protocol):
    def connectionMade(self):
        print "Connected from", self.transport.client
        self.transport.write('&lt;hits&gt;')
    def dataReceived(self, data):
        newhits = LOG.readlines()
        if not newhits:
            self.transport.write('&lt;none/&gt;')
        for hit in newhits:
            self.transport.write(hit_tag % log_fields(hit))
    def connectionLost(self, reason):
        print "Disconnected from", self.transport.client

factory = Factory()
factory.protocol = WebLog

if __name__=='__main__':
    global LOG
    LOG = open('access-log')
    LOG.seek(0, 2)     # Start at end of current access log
    reactor.listenTCP(8888, factory)
    reactor.run()
</code></pre></td></tr></table><p>
  Readers should refer to my prior tip for details on the client
  application. But the following change should be noted. The
  main client loop adds two lines:
</p><a name="IDA0DMVB"><b>Listing 3. Enhanced (blocking) client loop</b></a><br><table border="1" cellspacing="0" cellpadding="5" width="100%" bgcolor="#CCCCCC"><tr><td><pre><code>
while 1:
    xml_data = sock.recv(8192)
    parser.feed(xml_data)
    sleep(5)          # Delay before requesting new records
    sock.send('NEW?') # Send signal to indicate readiness
</code></pre></td></tr></table><p><a name="IDAEEMVB"><span class="atitle2">The parts of a Twisted server</span></a><br>
  A Twisted server consists of several modular elements.
  At a bytestream level, a server implements a protocol, often by
   inheriting from <code>twisted.internet.protocol.Protocol</code> or from
  some previously specialized child of it. For example, provided
   subclasses (in <code>twisted.protocols</code>) include
<code>dns</code>, <code>ftp</code>,
   <code>gnutella</code>, <code>http</code>,
 <code>nntp</code>, <code>shoutcast</code>,
and many others.
  Basically, a protocol should know how to handle making and
  losing connections, and receiving and sending data within a
  connection. These responsibilities are not much different than
   in a <code>SocketServer</code>-based server,
except in being slightly
  more modular in defining methods for each element.
</p><p>
  The next level of a Twisted server is a factory. In our
   <code>twisted-weblog-1.py</code> example, the factory
really does nothing
  besides store a protocol. In a more sophisticated server,
  however, a factory is a good place to perform initialization
  and finalization related to a protocol server. And probably of
  greatest interest, a factory can be persisted within
  <i xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">applications</i> (we will see those soon).
</p><p>
  Neither a protocol nor a factory knows anything about the
  network the server runs on. Instead, a <i xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">reactor</i> is a class
  that actually listens on a network (utilizing a factory
  instance for its protocol). Basically, a reactor is just a
  loop that listens on a given port and network interface (which
   one is chosen by calling a method like <code>.listenTCP()</code>,
   <code>.listenSSL()</code>, or <code>.listenUDP()</code>). The thing to understand is
   that the basic reactor in Twisted, <code>SelectReactor</code>, runs
  in a single thread; each connection is checked for new data,
  and the data is delivered to the relevant protocol object. An
  upshot is that a protocol object is <i xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">really</i> not allowed to
  block, or even just take too long to complete (protocols must
  be programmed appropriately).
</p><p><a name="IDAMGMVB"><span class="atitle2">An enhanced server</span></a><br>
  Let's try to enhance the Twisted Weblog server so that it
   follows the pattern of <code>SocketServer-weblog.py</code> in feeding new
  records to clients without the need for repeated requests from
   those clients. The problem here is inserting a <code>time.sleep()</code>
   call into a method of <code>WebLog(Protocol)</code>
causes it to block,
  and so is not allowed. While we are at it, notice that the
  prior servers probably do the wrong thing in that they feed
  each new batch of records only to one client. Presumably, if
  you want to allow multiple clients to monitor a Weblog, you
  want them all to receive ongoing updates.
</p><p>
  The way you delay actions in Twisted without blocking is
   to add callbacks to a reactor, using the <code>.callLater()</code> method.
  A callback added this way is added to the queue of events to
  service, but it will not actually be processed until after a
  specified delay. Putting both changes together, an enhanced
  Weblog server looks like:
</p><a name="IDAFHMVB"><b>Listing 4. twisted-weblog-1.py</b></a><br><table border="1" cellspacing="0" cellpadding="5" width="100%" bgcolor="#CCCCCC"><tr><td><pre><code>
from twisted.internet import reactor
from twisted.internet.protocol import Protocol, Factory
from webloglib import hit_tag, log_fields
import time

class WebLog(Protocol):
    def connectionMade(self):
        print "Connected from", self.transport.client
        self.transport.write('&lt;hits&gt;')
        self.ts = time.time()
        self.newHits()
    def newHits(self):
        for hit in self.factory.records:
            if self.ts &lt;= hit[0]:
                self.transport.write(hit_tag % log_fields(hit[1]))
        self.ts = time.time()
        reactor.callLater(5, self.newHits)
    def connectionLost(self, reason):
        print "Disconnected from", self.transport.client

class WebLogFactory(Factory):
    protocol = WebLog
    def __init__(self, fname):
        self.fname = fname
        self.records = []
    def startFactory(self):
        self.fp = open(self.fname)
        self.fp.seek(0, 2) # Start at end of current access log
        self.updateRecords()
    def updateRecords(self):
        ts = time.time()
        for rec in self.fp.readlines():
            self.records.append((ts, rec))
        self.records = self.records[-100:]  # Only keep last 100 hits
        reactor.callLater(1, self.updateRecords)
    def stopFactory(self):
        self.fp.close()

if __name__=='__main__':
    reactor.listenTCP(8888, WebLogFactory('access-log'))
    reactor.run()
</code></pre></td></tr></table><p>
  In this case, we define a custom factory and move some of the
   initialization from the <code>_main_</code> block to the
factory. Notice
  also that the clients for this server need not (and should not)
  sleep or send new requests -- in fact, I use the exact client
  application I discussed in the XML tip (see <a href="#resources" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">Resources</a>).</p><p>
  The factory and the protocol use the same technique in their
   custom methods <code>.updatedRecords()</code> and <code>.newHits()</code>,
  respectively. That is, if a method wants to run periodically, its
  last line can schedule it to run again at a specified delay. On
  its face, this pattern looks a lot like recursion -- but it is not 
  (moreover, the repeat scheduling need not occur on the
  last line; it just makes sense there). The method <code>.newHits()</code>,
  for example, simply lets the controlling reactor loop know that
  it wants to be called in another 5 seconds, but the method itself
  terminates. There is no requirement that a method schedule only
  itself -- it can schedule whatever it wants to occur, and
  functions quite apart from factory or protocol methods can be
  added to a reactor loop, if you wish.
</p><p><a name="IDAIYMVB"><span class="atitle2">Persistence and scheduling</span></a><br>
   Besides <code>reactor.callLater()</code> scheduling,
   Twisted contains a general class <code>twisted.internet.defer.Deferred</code>. In
  essence, <i xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">deferreds</i> are a generalization of scheduled callbacks,
  but allow techniques such as chaining dependent callbacks and
  handling error conditions in these chains. The idea behind a
  <code>Deferred</code> object is that when you call a
method, rather than
  wait for its results (which may take a while to arrive), the
  method can immediately return a <code>Deferred</code>
object that the
  reactor/scheduler can call again later, when results are expected
  to be available.
</p><p>
   I have not really played with <code>Deferred</code>
objects yet, but it
  feels like getting them right will be slightly tricky. If you
  need to wait on a blocking action -- say, the results from a
  remote database query -- it is not clear exactly how long you
   will need to wait for results to be available. <code>Deferred</code>
  objects <i xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">do</i> have a timeout mechanism, but I will have to come
  back to that in a later installment. Interested readers should
  at least know that the Twisted Matrix developers have attempted
  to provide a standard API for wrapping blocking actions. Of
  course, the worst case is to fall back to using threads for
  blocking actions that really cannot be converted into
  asynchronous callbacks.
</p><p>
  Another important element to Twisted servers is their easy
  support for persistence. A reactor is a loop that monitors and
  responds to I/O events. An application is much like an enhanced
  reactor that is able to pickle its state for later re-starting.
  Moreover, applications can be statefully saved into ".tap" files,
  and can be managed and daemonized using the tool <code>twistd</code>. 
  Here's a simple example that illustrates the usage (modelled on
  the Twisted documentation's <code>OneTimeKey</code>
example). This server
  delivers distinct Fibonacci numbers to all interested clients,
  without repeating numbers between them -- even if the server is
  stopped and started:
</p><a name="IDA0ZMVB"><b>Listing 5. fib_server.py</b></a><br><table border="1" cellspacing="0" cellpadding="5" width="100%" bgcolor="#CCCCCC"><tr><td><pre><code>
from twisted.internet.app import Application
from twisted.internet.protocol import Protocol, Factory

class Fibonacci(Protocol):
    "Serve a sequence of Fibonacci numbers to all requesters"
    def dataReceived(self, data):
        self.factory.new = self.factory.a + self.factory.b
        self.transport.write('%d' % self.factory.new)
        self.factory.a = self.factory.b
        self.factory.b = self.factory.new

def main():
    import fib_server    # Use script as namespace
    f = Factory()
    f.protocol = fib_server.Fibonacci
    f.a, f.b = 1, 1
    application = Application("Fibonacci")
    application.listenTCP(8888, f)
    application.save()

if '__main__' == __name__:
    main()
</code></pre></td></tr></table><p>
  You can see that mostly all we have changed is replacing
   <code>reactor</code> with <code>application</code> throughout. While the class
   <code>Application</code> also has a <code>.run()</code> method, we use its <code>.save()</code>
   method to create a <code>Fibonacci.tap</code> file.
Running this server is
  done as:
</p><a name="IDA30MVB"><b>Listing 6. Running fib_server.py</b></a><br><table border="1" cellspacing="0" cellpadding="5" width="100%" bgcolor="#CCCCCC"><tr><td><pre><code>
% python fib_server.py
% twistd -f Fibonacci.tap
...let server run, then shut it down...
% kill `cat twistd.pid`
...re-start server where it left off...
% twistd -f Fibonacci-shutdown.tap
...serve numbers where we left off...
</code></pre></td></tr></table><p>
  The client that connects to this server should use a
   <code>time.sleep()</code> in its loop if it only wants a
new number
  intermittently rather than as fast as possible. Obviously, a more
  useful server can provide a more interesting stateful datastream.
</p><p><a name="IDAM1MVB"><span class="atitle2">What next?</span></a><br>
  This article looked at fairly low-level details of Twisted
  -- defining custom protocols, and the like. But Twisted
  exists at many levels -- including high-level templating
  for Web services and other common protocols. In the next
  installments of this series, we will start to look at Web
  services specifically, and pick up some miscellaneous threads
  that were left dangling.
</p><p><a name="resources"><span class="atitle2">Resources</span></a><ul><li>For background on the starting point for the Twisted-based Weblog server discussed here, read David's tip, "<a href="http://www-106.ibm.com/developerworks/xml/library/x-tipasysax.html" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">Asynchronous SAX</a>" (<i xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">developerWorks,</i> May 2003).<br><br></li><li>"<a href="http://www-106.ibm.com/developerworks/webservices/library/ws-asynch1.html" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">A primer on asynchronous transactions</a>" (<i xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">developerWorks</i>, April 2002) looks at building a Web services architecture to handle requests and responses as separate transactions.<br><br></li><li>Read the parable of <a href="http://www.cs.princeton.edu/~rywang/berkeley/258/parable.html" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">The
Blind Men and the Elephant</a>.<br><br></li><li> Twisted comes with quite a bit of documentation and many
examples. Browse the <a href="http://twistedmatrix.com" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">Twisted Matrix Laboratories home page</a> to glean a greater sense of how the
Twisted framework works, and what has been implemented with it (or wait for
the next installments here at <i xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">developerWorks</i>).<br><br></li><li> Remi Delon has created a Web host service that specializes in
providing Python tools and libraries (including Twisted). For a Python Web
programmer, having a host with the most up-to-date versions of libraries
like Twisted, Zope, Webware, SkunkWeb, CherryPy, and others, is quite
useful. And in regards to this article, Remi has given the author a <a href="http://python-hosting.com" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">complimentary account</a> to use for testing scripts like those in this article.<br><br></li><li>Find <a href="http://www-106.ibm.com/developerworks/linux/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">more Python articles</a> in the <i xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">developerWorks</i> Linux zone.<br><br></li></ul></p><table border="0" cellspacing="0" cellpadding="0" width="100%"><tr><td><a name="author1"></a><span class="atitle2">About the author</span><br><img border="0" alt="David Mertz" src="http://www-106.ibm.com/developerworks/i/p-mertz.gif" height="71" width="64" align="left" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">David Mertz believes that it is turtles all the way down. David may be reached at <a href="mailto:mertz@gnosis.cx" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">mertz@gnosis.cx</a>; his life pored over at <a href="http://gnosis.cx/publish/." xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">his personal Web page</a>. David's book <a href="http://www.awprofessional.com/isapi/product_id~%7B5F1EAF18-40C5-4C46-9AC4-9CEF74BC3F0C%7D/catalog/product.asp" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><i>Text Processing in Python</i></a> was recently published by Addison-Wesley; check it out. Suggestions and recommendations on this, past, or future columns are welcome.</td></tr></table><br clear="all"><img src="/developerworks/i/c.gif" width="100" height="10" border="0" alt=""><br><table width="100%" cellspacing="0" cellpadding="0" border="0"><tr valign="top"><td width="100%" align="right"><a href="javascript:void newWindow()"><img src="/developerworks/i/icon-email.gif" width="46" height="26" border="0" alt="e-mail it!"></a></td><td width="5"><img src="/developerworks/i/c.gif" width="5" height="1" border="0" alt=""></td></tr><tr valign="top"><td colspan="2" bgcolor="#000000"><img src="/developerworks/i/c.gif" width="100" height="1" border="0" alt=""></td></tr><tr valign="top"><td colspan="2" bgcolor="#FFFFFF"><img src="/developerworks/i/c.gif" width="100" height="8" border="0" alt=""></td></tr></table><table width="100%" cellspacing="0" cellpadding="0" border="0" xmlns:fo="http://www.w3.org/1999/XSL/Format"><tr valign="top"><td><form method="POST" action="http://www.alphaworks.ibm.com/developerworks/ratings.nsf/RateArticle?CreateDocument"><input type="HIDDEN" name="ArticleTitle" value="Network programming with the Twisted framework, Part 1"><input type="HIDDEN" name="Zone" value="Linux"><input type="HIDDEN" name="RedirectURL" value="http://www-106.ibm.com/developerworks/thankyou/feedback-thankyou.html"><a name="rating"><b>What do you think of this document?</b></a><table border="0" cellpadding="0" cellspacing="0" width="600"><tr><td colspan="5"><img src="/developerworks/i/c.gif" width="100" height="8" border="0" alt=""></td></tr><tr valign="top"><td width="16%"><input type="RADIO" name="Rating" value="5">Killer! (5)</td><td width="20%"><input type="RADIO" name="Rating" value="4">Good stuff (4)</td><td width="24%"><input type="RADIO" name="Rating" value="3">So-so; not bad (3)</td><td width="22%"><input type="RADIO" name="Rating" value="2">Needs work (2)</td><td width="18%"><input type="RADIO" name="Rating" value="1">Lame! (1)</td></tr></table><br><b>Comments?</b><br><textarea name="Comments" wrap="virtual" rows="5" cols="60"></textarea><br><br><input type="SUBMIT" value="Submit feedback"></form></td></tr><tr valign="top"><td bgcolor="#FFFFFF"><img src="/developerworks/i/c.gif" width="100" height="8" border="0" alt=""></td></tr></table><table width="100%" cellspacing="0" cellpadding="0" border="0"><tr valign="top"><td width="100%"><table width="100%" cellspacing="0" cellpadding="0" border="0"><tr valign="top"><td width="100%"><img src="/developerworks/i/c.gif" width="2" height="4" border="0" alt=""><br><a class="dwbctl" href="http://www-106.ibm.com/developerworks/">IBM developerWorks</a>  &gt;  
        <a class="dwbctl" href="http://www-106.ibm.com/developerworks/linux/">Linux</a></td><td width="136" align="right"><a href="http://www-106.ibm.com/developerworks/"><img src="/developerworks/i/dwlogo-small.gif" width="136" height="24" border="0" alt="developerWorks"></a></td><td width="5"><img src="/developerworks/i/c.gif" width="5" height="1" border="0" alt=""></td></tr></table></td></tr></table></td><td width="1"><img src="/developerworks/i/c.gif" width="1" height="1" border="0" alt=""></td></tr></table><!-- IBM FOOTER -->
<table width="100%" cellspacing="0" cellpadding="0" border="0">
<tr>
<td><img src="/developerworks/i/c.gif" width="1" height="1" alt=""/></td>
</tr>
<tr valign="top">
<td height="21" class="bbg">&nbsp;&nbsp;<a href="http://www-106.ibm.com/developerworks/cgi-bin/click.cgi?url=http://www.ibm.com/ibm/?origin=dwheader" class="mainlink">About IBM</a><span class="divider">&nbsp;&nbsp;|&nbsp;&nbsp;</span><a href="http://www-106.ibm.com/developerworks/cgi-bin/click.cgi?url=http://www.ibm.com/privacy/?origin=dwheader" class="mainlink">Privacy</a><span class="divider">&nbsp;&nbsp;|&nbsp;&nbsp;</span><a href="http://www-106.ibm.com/developerworks/cgi-bin/click.cgi?url=http://www.ibm.com/legal/?origin=dwheader" class="mainlink">Legal</a><span class="divider">&nbsp;&nbsp;|&nbsp;&nbsp;</span><a href="http://www-106.ibm.com/developerworks/cgi-bin/click.cgi?url=http://www.ibm.com/contact/?origin=dwheader" class="mainlink">Contact</a></td>
</tr>
</table>
<!-- END IBM FOOTER -->

<!-- SURFAID METRICS ** 05/01/03 DO NOT ALTER ** -------------->
<script type="text/javascript" language="JavaScript1.2" src="//www.ibm.com/common/stats/stats.js"></script>
<noscript><img src="//stats.www.ibm.com/rc/images/uc.GIF?R=noscript" width="1" height="1" alt="" border="0" /></noscript></body></html>
